# Документация проекта ShoeStore

## Порядок развертывания системы

**Для корректной работы всех компонентов системы выполните следующие шаги:**

### 1. Установка и настройка базы данных
1. **Создание БД:** выполните скрипт `01_Create_Database.sql` в **SQL Server Management Studio (SSMS)**.
2. **Импорт данных:** загрузите данные из CSV-файлов в таблицы в **правильной последовательности** через мастер импорта SSMS:
   - В **Обозревателе объектов** SSMS щелкните правой кнопкой мыши по базе данных `ShoeStoreDb`.
   - Выберите **Задачи** → **Импорт неструктурированного файла...**.
   - В мастере импорта укажите нужный CSV-файл и следуйте шагам, нажимая **Далее**.
   - Повторите для всех CSV-файлов.
3. **Завершение настройки:** Выполните скрипт `02_Fix_Schema.sql` для установки связей и исправления данных.

### 2. Особенности работы с изображениями товаров

**Для корректного отображения изображений у товаров, загруженных из исходной базы данных:**

#### Вариант 1: Использование тестовых изображений

1. **Найдите тестовые изображения:**
   - Расположены в папке:  
     ```
     [папка_проекта]\Import\
     ```

2. **Скопируйте изображения в рабочую папку:**
   - При запуске оконного приложения `ShoeStoreDesktop` автоматически создается папка `Images`.
   - **Путь к рабочей папке `Images`:**
     ```
     [папка_проекта]\ShoeStoreSolution\ShoeStoreDesktop\bin\Debug\net10.0-windows\Images\
     ```
   - Скопируйте **все файлы изображений** (например, `1.jpg`, `2.jpg`) из папки `Import` в созданную папку `Images`.

3. **Результат:**
   - Товары из исходной БД будут отображаться с соответствующими изображениями.
   - В базе данных для этих товаров будет отображаться только имя файла (например: `1.jpg`).

#### Вариант 2: Загрузка новых изображений через интерфейс

Если тестовые изображения не нужны, можно:
1. Открыть любой товар для редактирования в оконном приложении.
2. Нажать кнопку **"Выбрать..."** и загрузить любое изображение с компьютера.
3. При сохранении изображение автоматически копируется в папку `Images`.

**Результат:**
- В базе данных будет сохранен полный путь к файлу.
- При следующем редактировании товара изображение будет автоматически загружено.

#### Примечание о формате хранения путей в базе данных:
- **Существующие товары (загружены из CSV):** хранят только имена файлов (например `1.jpg`).
- **Новые или отредактированные товары:** хранят полные пути к файлам в папке `Images` (например `C:\...\Images\1.jpg`).

**Оба варианта работоспособны и соответствуют требованиям задания.**

**Примечание:** в исходных данных не было установлено соответствие между названиями товаров и их изображениями. Поэтому товары могут отображаться с изображениями, которые не соответствуют их названию (например, туфли с изображением ботинок). Это особенность исходных данных, а не ошибка системы.

---

## Проектирование базы данных

Процесс проектирования базы данных начался с анализа трёх исходных файлов: `Tovar.xlsx`, `user_import.xlsx` и `Заказ_import.xlsx`. Подробный анализ нормализации данных с пошаговым приведением к третьей нормальной форме документирован в файле `Приведение_к_нормальной_форме.docx`. В ходе работы исходные Excel-файлы были модифицированы с созданием промежуточных таблиц для наглядного представления процесса нормализации.

## Инструменты разработки

Проект создавался в **SQL Server Management Studio** и **Visual Studio**. SSMS использовался для работы с базой данных, а Visual Studio — для написания кода приложений.

## Структура репозитория

### Файлы базы данных

#### SQL-скрипты
- **`01_Create_Database.sql`** - создаёт новую базу данных с именем `ShoeStoreDb`
- **`02_Fix_Schema.sql`** - основной скрипт конфигурации базы данных, который:
  - Исправляет ошибочные данные
  - Настраивает автоматическую генерацию идентификаторов
  - Устанавливает связи между таблицами через внешние ключи
  - Определяет типы данных и обязательные поля

#### CSV файлы с данными
- **`Categories.csv`** - содержит категории товаров для классификации продукции
- **`Suppliers.csv`** - включает информацию о компаниях-поставщиках
- **`Manufacturers.csv`** - список фирм-производителей обуви
- **`Products.csv`** - основной каталог товаров с детальной информацией
- **`Roles.csv`** - определяет роли пользователей в системе
- **`Users.csv`** - содержит учетные записи пользователей
- **`Customers.csv`** - список клиентов магазина
- **`Orders.csv`** - хранит информацию о совершенных заказах
- **`OrderItems.csv`** - детализированный состав каждого заказа

#### Диаграмма
- **`ER_диаграмма.png`** - графическое представление структуры базы данных в виде Entity-Relationship диаграммы

## Основное решение и проекты

Решение Visual Studio под названием **`ShoeStoreSolution`** включает четыре взаимосвязанных проекта, каждый из которых выполняет определённую роль в архитектуре системы.

### Библиотека классов ShoeStoreData
Служит фундаментом всего решения, содержит модели данных, контекст базы данных и общую бизнес-логику, реализованные с использованием **Entity Framework Core** для ORM-маппинга.

**Модели данных и их использование в заданиях:**

#### Основные модели сущностей:
- `Category` - категории товаров (используется в заданиях 1, 4, 6)
- `Supplier` - поставщики товаров (используется в заданиях 1, 4, 6)
- `Manufacturer` - производители обуви (используется в заданиях 1, 4, 6)
- `Role` - роли пользователей (используется в заданиях 1, 3, 5, 6)
- `User` - пользователи системы (используется в заданиях 1, 3, 5, 6)
- `Customer` - клиенты магазина (используется в заданиях 1, 5)
- `Order` - заказы (используется в заданиях 1, 3, 5)
- `OrderItem` - позиции заказов (используется в заданиях 1, 5)
- `Product` - товары (используется во ВСЕХ заданиях 1-6)

#### Вспомогательные классы:
- `ShoeStoreDbContext` - контекст базы данных для Entity Framework (используется во всех заданиях 2-6)
- `LoginRequest` - DTO для передачи данных авторизации (используется в заданиях 3 и 6)
- `AuthOptions` - настройки JWT аутентификации (используется только в задании 3)

### Веб-API проект ShoeStoreAPI
Предоставляет **RESTful интерфейс** для взаимодействия с системой через HTTP-запросы. **Используется в задании 3.**

**Контроллеры:**
- `AuthController` - управление **авторизацией** с использованием JWT-токенов
- `ProductsController` - операции с товарами (CRUD)
- `OrdersController` - работа с заказами
- `TestController` - тестовый контроллер для проверки работы API

**Дополнительные классы:**
- `OrderUpdateDto` - DTO для обновления заказов

**Используемые модели:** `Product`, `Order`, `User`, `Role`, `LoginRequest`, `OrderUpdateDto`

### Веб-приложение ShoeStoreWeb
Построенное на технологии **Razor Pages**, представляет собой пользовательский интерфейс для клиентов магазина. **Используется в заданиях 4 и 5.**

**Страницы:**
- `Products/Index` - главная страница с каталогом товаров (задание 4)
- `Account/Login` - страница авторизации пользователей (задание 5)
- `Account/Logout` - обработка выхода из системы (задание 5)
- `Orders/Index` - просмотр заказов (задание 5)

**Используемые модели:**
- **Задание 4:** `Product`, `Manufacturer`, `Category`, `Supplier`
- **Задание 5:** `Product`, `Order`, `OrderItem`, `User`, `Customer`

### Оконное приложение ShoeStoreDesktop
Разработанное на платформе **WPF**, предназначено для администраторов и менеджеров магазина. **Используется в задании 6.**

**Окна:**
- `LoginWindow` - окно авторизации
- `MainWindow` - главное окно с каталогом товаров
- `AddEditProductWindow` - окно добавления/редактирования товаров
- `DeleteProductsWindow` - окно подтверждения удаления товаров
- `SelectProductsWindow` - окно выбора товаров для операций
- `OrdersWindow` - окно просмотра заказов

**Конвертеры (Converters):**
- `StringToImageConverter` - преобразование пути к изображению в BitmapImage
- `PriceDisplayConverter` - форматирование отображения цен
- `QuantityToTextConverter` - преобразование количества в текстовый статус
- `DiscountToBackgroundConverter` - установка фона в зависимости от скидки
- `DiscountToForegroundConverter` - установка цвета текста в зависимости от скидки
- `DiscountToTextConverter` - форматирование текста скидки
- `DiscountLabelConverter` - преобразование скидки в текстовую метку
- `IntToVisibilityConverter` - преобразование числа в видимость элемента
- `IntToInverseVisibilityConverter` - обратное преобразование видимости
- `QuantityToBackgroundConverter` - установка фона в зависимости от наличия товара

**Используемые модели:** все модели сущностей из `ShoeStoreData.Models`, а также `LoginRequest` для авторизации.

## Архитектура системы

Все три клиентских приложения зависят от библиотеки классов `ShoeStoreData`, что обеспечивает единообразие доступа к данным и исключает дублирование кода, создавая целостную модульную архитектуру системы.

---

## Выполнение заданий

### Задание 1. Разработка базы данных
**Выполнено полностью**
- Проведена нормализация до 3NF
- Созданы все необходимые таблицы
- Реализованы первичные и внешние ключи
- Использованы оптимальные типы данных
- Настроены автоинкрементные значения
- Сохранена ER-диаграмма в формате PNG
- Все данные экспортированы в CSV

**Используемые модели:** все модели сущностей из `ShoeStoreData.Models`

### Задание 2. Создание решения и библиотеки классов
**Выполнено полностью**
- Создано решение с 4 проектами
- Реализована библиотека классов с контекстом данных
- Использован Entity Framework Core для ORM
- Добавлены необходимые DTO
- Библиотека используется во всех клиентских приложениях

**Используемые компоненты:** все модели, контекст и DTO из `ShoeStoreData`

### Задание 3. Создание веб-API
**Выполнено полностью**
- Реализована **авторизация по логину и паролю с использованием JWT токенов** (`AuthOptions` и `LoginRequest`)
- Созданы контроллеры для товаров (`ProductsController`) и заказов (`OrdersController`)
- Настроена ролевая авторизация на основе модели `Role`
- Реализован доступ к заказам по логину пользователя (модель `User`)
- Добавлена возможность изменения статуса заказа через `OrderUpdateDto`

**Реализованные методы API:**

**AuthController:**
- `POST /api/auth/login` - авторизация с JWT токеном

**ProductsController:**
- `GET /api/products` - получение всех товаров
- `GET /api/products/{article}` - товар по артикулу  
- `POST /api/products` - добавление товара (Администратор/Менеджер)
- `PUT /api/products/{article}` - обновление товара (Администратор/Менеджер)
- `DELETE /api/products/{article}` - удаление товара (Администратор/Менеджер)

**OrdersController:**
- `GET /api/orders/user/{login}` - заказы пользователя (авторизация)
- `PUT /api/orders/{id}` - изменение статуса и даты доставки (Администратор/Менеджер)

**Тестирование API:**
- Swagger UI доступен по адресу: `http://localhost:5032/swagger/index.html`
- При запуске проекта `ShoeStoreAPI` открывается интерфейс Swagger для тестирования
- JWT токен добавляется через кнопку "Authorize" в Swagger

**Используемые модели:** `Product`, `Order`, `User`, `Role`, `LoginRequest`, `OrderUpdateDto`, `AuthOptions`

**Примечание:** в проекте присутствуют автоматически сгенерированные MVC Views (`.cshtml` файлы), которые не используются в реализации задания. Задание 3 выполнено через API контроллеры, веб-интерфейс реализован в отдельном проекте `ShoeStoreWeb`.

### Задание 4. Просмотр списка товаров в веб-приложении
**Выполнено полностью**
- Отображение товаров с фотографиями (используется модель `Product`)
- Все виды фильтрации: по описанию, производителю (`Manufacturer`), цене
- Отображение товаров только со скидкой
- Отображение товаров только в наличии
- Все виды сортировки по названию, поставщику (`Supplier`), цене
- Отображение цены после применения скидки
- Отображение связанных данных через модели `Category`, `Supplier`, `Manufacturer`

**Используемые модели:** `Product`, `Manufacturer`, `Category`, `Supplier`

### Задание 5. Работа с заказами в веб-приложении
**Выполнено полностью**
- Авторизация пользователей (модель `User`)
- Отображение ФИО пользователя
- Создание новых заказов для клиентов (модели `Order`, `OrderItem`, `Customer`)
- Раздельный просмотр заказов по ролям
- Автоматическое заполнение данных заказа:
  - Дата заказа - текущая дата
  - Дата доставки - через неделю
  - Код получения - случайное число 100-999
  - Статус - "Новый"

**Используемые модели:** `Product`, `Order`, `OrderItem`, `User`, `Customer`

### Задание 6. Работа с товарами в оконном приложении
**Выполнено полностью**
- Окно авторизации при запуске с использованием `LoginRequest`
- Просмотр товаров с фильтрацией и сортировкой
- Визуальное выделение с помощью конвертеров:
  - Товаров со скидкой (красная основная цена)
  - Отсутствующих товаров (голубой фон строки)
- Управление товарами для ролей Менеджер и Администратор (модель `Role`):
  - Добавление новых товаров
  - Редактирование существующих товаров
  - Удаление выбранных товаров
  - Загрузка/замена изображений товаров
- Обновление данных после модификации товаров
- Просмотр заказов в отдельном окне

**Используемые модели:** все модели сущностей из `ShoeStoreData.Models`, `LoginRequest`, все конвертеры

---

## Настройка подключения и запуск

### Настройка подключения к БД
- Проверить строку подключения в `ShoeStoreDbContext`
- При необходимости обновить параметры подключения в файлах конфигурации

### Запуск приложений
1. **Веб-API:** запустить проект `ShoeStoreAPI`
2. **Веб-приложение:** запустить проект `ShoeStoreWeb`
3. **Оконное приложение:** запустить проект `ShoeStoreDesktop`

*Примечание: при тестировании все приложения запускались через локальный сервер (localhost).*

# Возможная ошибка при первом запуске проекта

При развертывании проекта **ShoeStoreSolution** на новом компьютере с только что установленной **Visual Studio 2026** может возникнуть ошибка, связанная с восстановлением пакетов NuGet. Проблема проявляется при первой сборке или запуске проекта, когда среда разработки автоматически пытается выполнить команду `dotnet restore`. Система может сообщать об ошибке **"Не удалось скачать пакеты: соединение разорвано"**.

Для решения этой проблемы выполните следующие шаги по порядку.

## Шаг 1: Проверка версии .NET SDK

Проект построен на платформе **.NET 10.0**. Убедитесь, что на целевом компьютере установлена корректная версия SDK.

1.  Откройте **PowerShell** (или Командную строку).
2.  Введите команду для проверки установленных версий:
    ```powershell
    dotnet --list-sdks
    ```
3.  В списке должна присутствовать версия **10.0.101** или выше (например, `10.0.101 [C:\Program Files\dotnet\sdk]`).
4.  Если нужная версия отсутствует, скачайте и установите **.NET 10.0 SDK** с [официального сайта Microsoft](https://dotnet.microsoft.com/download).

## Шаг 2: Использование VPN для доступа к репозиторию

В некоторых случаях доступ к основному репозиторию пакетов NuGet (`nuget.org`) может быть ограничен на уровне сети. Решением является использование VPN.

1.  Установите и запустите любое доверенное **VPN-приложение** на компьютере.
2.  Активируйте соединение и выберите стабильный сервер.
3.  После установки защищенного подключения повторите попытку восстановления пакетов (см. Шаг 5). Этот способ успешно решает проблему с "разорванным соединением".

## Шаг 3: Очистка кэша NuGet

Поврежденный или заблокированный локальный кэш пакетов может мешать их загрузке.

1.  В **PowerShell** (рекомендуется запустить от имени Администратора) выполните команду:
    ```powershell
    dotnet nuget locals all --clear
    ```
2.  Команда очистит все локальные хранилища пакетов. Если в процессе возникает ошибка о том, что файл используется другим процессом, закройте все экземпляры **Visual Studio** и повторите команду.

## Шаг 4: Временное отключение брандмауэра и антивируса

Встроенный брандмауэр Windows или стороннее антивирусное ПО могут блокировать сетевые запросы, необходимые для загрузки пакетов.

1.  **Временно отключите Брандмауэр Защитника Windows** (через Параметры Windows > Обновление и безопасность > Безопасность Windows > Брандмауэр и защита сети).
2.  Если установлен сторонний антивирус (Avast, Kaspersky и др.), также отключите его защиту на 5-10 минут.
3.  **Важно:** После выполнения восстановления пакетов обязательно снова включите все системы защиты.

## Шаг 5: Переход в папку решения и восстановление пакетов

Все операции по восстановлению зависимостей необходимо выполнять из корневой папки решения (где находится файл `ShoeStoreSolution.sln`).

1.  Откройте **PowerShell**.
2.  Перейдите в папку с проектом, используя команду `cd`. Вместо `[ПОЛНЫЙ_ПУТЬ_К_ПАПКЕ]` укажите свой путь:
    ```powershell
    cd "[ПОЛНЫЙ_ПУТЬ_К_ПАПКЕ]"
    ```
3.  Выполните команду принудительного восстановления всех пакетов для решения:
    ```powershell
    dotnet restore --force
    ```

После успешного выполнения этих шагов все зависимости проекта будут загружены. Теперь вы можете открыть файл решения `ShoeStoreSolution.sln` в Visual Studio 2026, и проект должен успешно собираться и запускаться.

## Демонстрационные данные для тестирования

После развертывания системы для тестирования можно использовать следующие учетные записи из файла `Users.csv`:

**Администратор (полный доступ ко всем функциям):**
- Логин: 94d5ous@gmail.com
- Пароль: uzWC67
- Применение: тестирование всех функций в веб-приложении и оконном приложении

**Менеджер (управление товарами и заказами):**
- Логин: 1diph5e@tutanota.com
- Пароль: 8ntwUp
- Применение: тестирование функций управления товарами в оконном приложении (задание 6)

**Клиент (покупка товаров):**
- Логин: 5d4zbu@tutanota.com
- Пароль: rwVDh9
- Применение: тестирование оформления заказов в веб-приложении (задания 4 и 5)

**Примечание по ролям в системе:** 
в заданиях 3, 5 и 6 указаны следующие требования:
- "Редактирование товаров и изменение статуса и даты доставки заказа должны быть доступны для авторизованных пользователей с ролью **администратор или менеджер**" (задание 3)
- "После авторизации пользователям становится доступен переход к странице «Заказы»: клиент может увидеть список своих заказов в виде таблицы, **менеджер и администратор** могут увидеть список всех заказов в виде таблицы" (задание 5)
- "Пользователи с ролью **менеджер и администратор** имеют возможность перехода к окну добавления нового товара или редактирования выбранного" (задание 6)

В соответствии с этими формулировками, роли **Администратор** и **Менеджер** имеют одинаковые права доступа в системе. Такое решение соответствует требованиям технического задания.

## Особенности реализации

### Соблюдение требований к стилю
- Использован шрифт Times New Roman
- Основной фон: #FFFFFF (белый)
- Дополнительный фон: #7FFF00
- Акцентирование внимания: #00FA9A
- Для скидки более 15%: фон #2E8B57
- Установлен логотип и иконка на всех формах

### Безопасность
- JWT авторизация в API с использованием `AuthOptions`
- Ролевая модель доступа на основе модели `Role`
- Проверка прав доступа для операций в соответствии с ролью

### Обработка данных
- Валидация входных данных на стороне клиента и сервера
- Обработка исключительных ситуаций с информативными сообщениями

## Примечания

Все задания выполнены в полном объеме. Система готова к использованию и проверке. 

**Комментарии в коде:** в соответствии с требованиями задания, все разработанные методы содержат комментарии, объясняющие работу кода. Комментарии добавлены ко всем ключевым методам в контроллерах API, обработчикам событий в WPF и Razor Pages, конвертерам и другим важным компонентам системы.

**Использование компонентов по заданиям:**
- **Модели сущностей** (`Product`, `Order`, `User` и др.) используются во всех соответствующих заданиях
- **Контекст базы данных** (`ShoeStoreDbContext`) используется во всех заданиях кроме первого
- **DTO** (`LoginRequest`, `OrderUpdateDto`) используются в API и WPF приложениях
- **Конвертеры** используются только в WPF приложении для визуального оформления
- **Настройки авторизации** (`AuthOptions`) используются только в веб-API
